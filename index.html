<html>
<head>
<title>Presentation Timer</title>
<style>

body { 
	background: #113; 
	margin: 30px; 
	color: white;
	
	font: normal 14px Helvetica,Verdana;
	letter-spacing: -0.5px;
	text-align: center;
}

#countdownText { 
	font: bold 60px Calibri,Helvetica,Verdana;
	color: white;
	letter-spacing: 1px;
	margin-bottom: 20px;
}

#countdownGraph {  padding: 10px; }

</style>

</head>
<body>

<div id="countdownText"></div>

<div id="countdownGraph">
	<canvas id="countdownGraphCanvas"></canvas>
</div>







<script src="jquery-2.0.3.min.js"></script>

<script type="text/javascript">


var isTimerRunning = false;
var finished = false;
var startTime = 0;
var endTime = 0;


function drawPieAt(ctx, x, y, radius, startRadian, finishRadian, color) {
	ctx.fillStyle = color
	ctx.beginPath();
	ctx.arc(x, y, radius, startRadian, finishRadian, false );
	ctx.lineTo(x, y);
	ctx.closePath();
	ctx.fill();
}


// Draws a slice of a pie chart clockwise, 0 = 12pm, 0.5 = 6pm
function drawPie(canvas, start, finish, color) {

	var canvas_size = [canvas.width, canvas.height];
	var radius = Math.min(canvas_size[0], canvas_size[1]) / 2;
	var center = [canvas_size[0]/2, canvas_size[1]/2];
	
	// Rotate from 12pm to 3pm and convert to radians
	start = (start + 0.75) % 1;
	var startRadian = start * 2 * Math.PI;
	finish = (finish + 0.75) % 1;
	var finishRadian = finish * 2 * Math.PI;
	
	var ctx = canvas.getContext("2d");
	drawPieAt( ctx, center[0], center[1], radius, startRadian, finishRadian, color );
}

function clearCanvas(canvas) {
	var ctx = canvas.getContext("2d");
	ctx.clearRect( 0, 0, canvas.width, canvas.height );
}


function updateGraph() {
	
	var width = 500; 
	var completed = "DarkSlateBlue";
	var remainingGreen = "Chartreuse";
	var remainingYellow = "Yellow";
	var remainingRed = "Red";
	var start = remainingGreen;
	var end = remainingRed;

	
	var canvas = document.getElementById("countdownGraphCanvas");
	if ( !canvas.getContext ) { return; }
	canvas.width = canvas.height = width;
	
	var now = new Date().getTime();
	
	// If the countdown is over draw the completed circle
	if ( now > endTime ) {
		if ( finished ) fullCircle(canvas, end);
		else fullCircle( canvas, start );
		return;
	}
	
	var pctDone = (now - startTime) / (endTime - startTime);
	if ( pctDone < 0.005 ) {
		fullCircle( canvas, remainingGreen );
		return;
	}
	
	var remaining = remainingGreen;
	if ( pctDone >= 0.75 ) remaining = remainingYellow;
	if ( pctDone >= 0.9 ) remaining = remainingRed;
	
	clearCanvas( canvas );
	drawPie( canvas, 0, pctDone, completed );
	drawPie( canvas, pctDone, 0, remaining );
	
}

function fullCircle(canvas, color) {
		drawPie( canvas, 0, 0.5, color );
		drawPie( canvas, 0.5, 0, color );
}


function countdown() {
	
	// Bail if timer is stopped
	if ( ! isTimerRunning ) { return; }
	
	var margin = 0.25;
	var now = new Date().getTime() + margin;
	if ( endTime < now ) {
		finish();
		return; 
	}
	
	var text = getCountdownText(endTime - now);
	$("#countdownText").text( text );
	
	updateGraph();
	
	var remaining = 1000 - (new Date().getTime() % 1000);
	setTimeout( countdown, remaining );
}


function getCountdownText(remainingMsecs) {
	var remainingSecs = Math.floor(remainingMsecs / 1000);
	var remainingMinutes = Math.floor(remainingSecs / 60);
	
	if ( remainingMinutes < 1 ) {
		if ( remainingSecs > 10 ) { 
			return (remainingSecs -= (remainingSecs % 10)) + "+ seconds left"
		}
		else {
			return "only " + remainingSecs + " seconds left";
		}
	}
	else {
		return remainingMinutes + "+ minutes left";
	}		
}



function getTimerDuration() { return window.location.hash.slice(1) || 3  }


function start() {
	isTimerRunning = true;
	
	var minutes = getTimerDuration();
	var duration = minutes * 60 * 1000;
	var now = new Date().getTime();
	startTime = now + (1000 - now % 1000);
	endTime = startTime + duration;
	
	var remaining = 1000 - (now % 1000);
	setTimeout( countdown, remaining );
}


function finish() {
	isTimerRunning = false;
	finished = true;
	$("#countdownText").html("Fin");
	updateGraph();
	$("#countdownGraph").off('click');
}


$(document).ready( function() {

	$("#countdownText").text(getTimerDuration() + " minute countdown");

	document.title = getTimerDuration() + "m timer";
	
	$("#countdownGraph").click( function() {
		if ( isTimerRunning ) { window.location.reload(); }
		else { start(); }
	});

	updateGraph();

});


</script>

</body>
</html>
